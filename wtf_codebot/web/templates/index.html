<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WTF Codebot - Web Interface</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        .main-container {
            min-height: calc(100vh - 56px); /* Subtract navbar height */
            padding: 1rem;
        }
        .analysis-container {
            height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
        }
        .file-tree {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 0.5rem;
            background-color: #fdfdfd;
        }
        .directory-navigation {
            padding: 0.75rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 0.375rem 0.375rem 0 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-button {
            background: none;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            transition: all 0.15s ease-in-out;
        }
        .nav-button:hover:not(:disabled) {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .current-path {
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #e9ecef;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .tree-item {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            margin: 0.125rem 0;
            border-radius: 0.25rem;
            transition: background-color 0.15s ease-in-out;
            user-select: none;
        }
        .tree-item:hover {
            background-color: #f1f3f4;
        }
        .tree-item.excluded {
            background-color: #f8d7da;
            color: #721c24;
        }
        .tree-item.excluded:hover {
            background-color: #f5c6cb;
        }
        .tree-checkbox {
            margin-right: 0.5rem;
            cursor: pointer;
        }
        .tree-checkbox:indeterminate {
            opacity: 0.6;
        }
        .expand-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.125rem;
            margin-right: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.125rem;
            transition: all 0.15s ease-in-out;
        }
        .expand-toggle:hover {
            background-color: #e9ecef;
        }
        .expand-toggle.invisible {
            visibility: hidden;
        }
        .tree-icon {
            margin-right: 0.5rem;
            width: 1rem;
            text-align: center;
            color: #6c757d;
        }
        .tree-name {
            flex-grow: 1;
            cursor: pointer;
            padding: 0.125rem 0.25rem;
            border-radius: 0.125rem;
        }
        .tree-name:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .tree-meta {
            font-size: 0.75rem;
            color: #6c757d;
            margin-left: 0.5rem;
        }
        .tree-children {
            margin-left: 1.5rem;
            border-left: 1px dotted #dee2e6;
            padding-left: 0.5rem;
        }
        .tree-children.collapsed {
            display: none;
        }
        .analysis-result {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            flex: 1;
            overflow-y: auto;
        }
        .progress {
            height: 1.5rem;
            background-color: #e9ecef;
            border-radius: 0.375rem;
            overflow: hidden;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .progress-text {
            position: relative;
            z-index: 1;
        }
        .loading {
            text-align: center;
            padding: 2rem;
        }
        .status-badge {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
        }
        .directory-input {
            margin-bottom: 1rem;
        }
        .exclusion-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .exclusion-tag {
            background-color: #dc3545;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .exclusion-tag .remove-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
        }
        .selection-controls {
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .btn-sm-custom {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.2rem;
        }
        .analysis-results {
            font-size: 0.9rem;
        }
        .analysis-results .card {
            border: none;
            box-shadow: 0 0.125rem 0.5rem rgba(0,0,0,0.08);
            transition: transform 0.2s ease-in-out;
        }
        .analysis-results .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,0.12);
        }
        .analysis-results .card-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .analysis-results .card-text {
            font-size: 0.875rem;
            color: #6c757d;
            font-weight: 500;
        }
        .analysis-results pre {
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.8rem;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }
        .analysis-results .table {
            font-size: 0.875rem;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        .analysis-results .table thead {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        .analysis-results .badge {
            font-size: 0.75rem;
            padding: 0.35em 0.65em;
            font-weight: 500;
        }
        .findings-card {
            border-left: 4px solid;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        .findings-card:hover {
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
        }
        .findings-card.severity-high {
            border-left-color: #dc3545;
        }
        .findings-card.severity-medium {
            border-left-color: #ffc107;
        }
        .findings-card.severity-low {
            border-left-color: #17a2b8;
        }
        .section-header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .section-header h6 {
            font-weight: 600;
            color: #495057;
        }
        .summary-icon {
            font-size: 2.5rem;
            opacity: 0.15;
            position: absolute;
            right: 1rem;
            top: 1rem;
        }
        .vulnerability-card {
            border-radius: 0.5rem;
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
        }
        .empty-state {
            padding: 3rem;
            text-align: center;
            color: #6c757d;
        }
        .empty-state i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 1rem;
        }
        .current-picker-path {
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #e9ecef;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
        }
        .directory-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #fdfdfd;
        }
        .directory-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        .directory-item:hover {
            background-color: #f8f9fa;
        }
        .directory-item:last-child {
            border-bottom: none;
        }
        .directory-item.selected {
            background-color: #e7f3ff;
            border-left: 4px solid #0d6efd;
        }
        .directory-item .fas {
            margin-right: 0.75rem;
            color: #6c757d;
            width: 1.25rem;
            text-align: center;
        }
        .directory-item.common {
            background-color: #f8f9fa;
            border-left: 4px solid #198754;
        }
        .directory-item.common .fas {
            color: #198754;
        }
        .common-dir-btn {
            background-color: #198754;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out;
        }
        .common-dir-btn:hover {
            background-color: #157347;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-robot"></i> WTF Codebot
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span id="status-badge" class="status-badge bg-secondary">Ready</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid main-container">
        <div class="row">
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-folder-open"></i> Directory Browser</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="directory-input p-3 pb-0">
                            <label for="directory-path" class="form-label">Directory Path</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="directory-path" value="." placeholder="Enter directory path">
                                <button class="btn btn-outline-secondary" type="button" id="browse-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                                <button class="btn btn-outline-primary" type="button" id="directory-picker-btn" data-bs-toggle="modal" data-bs-target="#directoryPickerModal">
                                    <i class="fas fa-folder-open"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Navigation Controls -->
                        <div class="directory-navigation">
                            <button class="nav-button" id="parent-dir-btn" title="Go to parent directory">
                                <i class="fas fa-level-up-alt"></i>
                            </button>
                            <button class="nav-button" id="refresh-btn" title="Refresh directory">
                                <i class="fas fa-sync"></i>
                            </button>
                            <div class="current-path" id="current-path">.</div>
                        </div>
                        
                        <!-- Selection Controls -->
                        <div class="selection-controls">
                            <button class="btn btn-outline-primary btn-sm-custom" id="select-all-btn">
                                <i class="fas fa-check-square"></i> All
                            </button>
                            <button class="btn btn-outline-secondary btn-sm-custom" id="select-none-btn">
                                <i class="fas fa-square"></i> None
                            </button>
                            <button class="btn btn-outline-warning btn-sm-custom" id="expand-all-btn">
                                <i class="fas fa-expand-arrows-alt"></i> Expand
                            </button>
                            <button class="btn btn-outline-info btn-sm-custom" id="collapse-all-btn">
                                <i class="fas fa-compress-arrows-alt"></i> Collapse
                            </button>
                        </div>
                        
                        <div id="file-tree" class="file-tree">
                            <div class="loading">
                                <i class="fas fa-spinner fa-spin"></i> Loading...
                            </div>
                        </div>
                    </div>
                </div>

                
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-ban"></i> Excluded Paths</h5>
                    </div>
                    <div class="card-body">
                        <div id="exclusion-tags" class="exclusion-tags">
                            <!-- Exclusion tags will be populated here -->
                        </div>
                        <button class="btn btn-sm btn-outline-danger mt-2" id="clear-exclusions">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="card analysis-container">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-cogs"></i> Analysis</h5>
                        <div>
                            <button class="btn btn-outline-info" id="history-btn">
                                <i class="fas fa-history"></i> History
                            </button>
                            <button class="btn btn-primary ms-2" id="analyze-btn">
                                <i class="fas fa-play"></i> Run Analysis
                            </button>
                            <div class="btn-group ms-2">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" id="export-btn" disabled>
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" data-format="json">JSON</a></li>
                                    <li><a class="dropdown-item" href="#" data-format="markdown">Markdown</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body d-flex" style="overflow: hidden; padding: 0;">
                        <div id="analysis-result" class="analysis-result w-100">
                            <div class="text-center text-muted">
                                <i class="fas fa-info-circle"></i>
                                <p class="mt-2">No analysis has been run yet. Select a directory and click "Run Analysis" to get started.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Directory Picker Modal -->
    <div class="modal fade" id="directoryPickerModal" tabindex="-1" aria-labelledby="directoryPickerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="directoryPickerModalLabel">
                        <i class="fas fa-folder-open"></i> Select Directory
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="directory-picker-nav mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-outline-secondary btn-sm" id="picker-home-btn">
                                <i class="fas fa-home"></i> Home
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="picker-root-btn">
                                <i class="fas fa-hdd"></i> Root
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="picker-parent-btn">
                                <i class="fas fa-level-up-alt"></i> Parent
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="picker-refresh-btn">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        <div class="mt-2">
                            <div class="current-picker-path" id="current-picker-path">/</div>
                        </div>
                    </div>
                    
                    <div class="directory-picker-content">
                        <div id="common-directories" class="mb-3" style="display: none;">
                            <h6 class="text-muted">Common Directories</h6>
                            <div id="common-dirs-list" class="d-flex flex-wrap gap-2 mb-3">
                                <!-- Common directories will be populated here -->
                            </div>
                        </div>
                        
                        <div id="directory-list" class="directory-list">
                            <div class="text-center p-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading directories...
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="flex-grow-1">
                        <small class="text-muted">Selected: <span id="selected-directory-display">None</span></small>
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="select-directory-btn" disabled>Select Directory</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global state
        let currentDirectory = '.';
        let excludedPaths = [];
        let includedPaths = [];  // Paths to include in analysis
        let analysisResult = null;
        let fileTreeData = null;
        let expandedNodes = new Set();
        
        // Directory picker state
        let pickerCurrentDirectory = '/';
        let pickerSelectedDirectory = null;
        let pickerData = null;

        // DOM elements
        const directoryInput = document.getElementById('directory-path');
        const browseBtn = document.getElementById('browse-btn');
        const parentDirBtn = document.getElementById('parent-dir-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const currentPathDiv = document.getElementById('current-path');
        const selectAllBtn = document.getElementById('select-all-btn');
        const selectNoneBtn = document.getElementById('select-none-btn');
        const expandAllBtn = document.getElementById('expand-all-btn');
        const collapseAllBtn = document.getElementById('collapse-all-btn');
        const fileTree = document.getElementById('file-tree');
        const analyzeBtn = document.getElementById('analyze-btn');
        const exportBtn = document.getElementById('export-btn');
        const statusBadge = document.getElementById('status-badge');
        const exclusionTags = document.getElementById('exclusion-tags');
        const clearExclusionsBtn = document.getElementById('clear-exclusions');
        const analysisResultDiv = document.getElementById('analysis-result');
        const historyBtn = document.getElementById('history-btn');
        
        // Directory picker elements
        const directoryPickerBtn = document.getElementById('directory-picker-btn');
        const pickerHomeBtn = document.getElementById('picker-home-btn');
        const pickerRootBtn = document.getElementById('picker-root-btn');
        const pickerParentBtn = document.getElementById('picker-parent-btn');
        const pickerRefreshBtn = document.getElementById('picker-refresh-btn');
        const currentPickerPathDiv = document.getElementById('current-picker-path');
        const commonDirectoriesDiv = document.getElementById('common-directories');
        const commonDirsList = document.getElementById('common-dirs-list');
        const directoryList = document.getElementById('directory-list');
        const selectedDirectoryDisplay = document.getElementById('selected-directory-display');
        const selectDirectoryBtn = document.getElementById('select-directory-btn');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFileTree();
            updateExclusionTags();
            
            // Event listeners
            browseBtn.addEventListener('click', () => {
                currentDirectory = directoryInput.value;
                loadFileTree();
            });

            parentDirBtn.addEventListener('click', goToParentDirectory);
            refreshBtn.addEventListener('click', () => loadFileTree());
            
            selectAllBtn.addEventListener('click', () => setAllSelections(false)); // false = include all
            selectNoneBtn.addEventListener('click', () => setAllSelections(true)); // true = exclude all
            expandAllBtn.addEventListener('click', () => setAllExpanded(true));
            collapseAllBtn.addEventListener('click', () => setAllExpanded(false));

            directoryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentDirectory = directoryInput.value;
                    loadFileTree();
                }
            });

            analyzeBtn.addEventListener('click', runAnalysis);
            clearExclusionsBtn.addEventListener('click', clearExclusions);
            historyBtn.addEventListener('click', showAnalysisHistory);

            // Export dropdown handlers
            document.querySelectorAll('.dropdown-item[data-format]').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    exportAnalysis(e.target.dataset.format);
                });
            });

            // Directory picker event listeners
            directoryPickerBtn.addEventListener('click', () => {
                // Initialize picker with current directory or home
                pickerCurrentDirectory = currentDirectory === '.' ? getCurrentUserHome() : currentDirectory;
                loadDirectoryPicker();
            });

            pickerHomeBtn.addEventListener('click', () => {
                pickerCurrentDirectory = getCurrentUserHome();
                loadDirectoryPicker();
            });

            pickerRootBtn.addEventListener('click', () => {
                pickerCurrentDirectory = '/';
                loadDirectoryPicker();
            });

            pickerParentBtn.addEventListener('click', () => {
                if (pickerData && pickerData.parent_directory) {
                    pickerCurrentDirectory = pickerData.parent_directory;
                    loadDirectoryPicker();
                }
            });

            pickerRefreshBtn.addEventListener('click', loadDirectoryPicker);

            selectDirectoryBtn.addEventListener('click', () => {
                if (pickerSelectedDirectory) {
                    currentDirectory = pickerSelectedDirectory;
                    directoryInput.value = currentDirectory;
                    currentPathDiv.textContent = currentDirectory;
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('directoryPickerModal'));
                    modal.hide();
                    
                    // Load the new directory
                    loadFileTree();
                }
            });
        });

        // Load file tree
        async function loadFileTree() {
            try {
                setStatus('Loading...', 'warning');
                const response = await fetch(`/api/file-tree?directory=${encodeURIComponent(currentDirectory)}`);
                const data = await response.json();
                
                if (response.ok) {
                    fileTreeData = data;
                    currentDirectory = data.current_directory;
                    directoryInput.value = currentDirectory;
                    currentPathDiv.textContent = currentDirectory;
                    
                    // Update parent directory button
                    parentDirBtn.disabled = !data.parent_directory;
                    
                    renderFileTree();
                    setStatus('Ready', 'secondary');
                } else {
                    throw new Error(data.detail || 'Failed to load file tree');
                }
            } catch (error) {
                fileTree.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                setStatus('Error', 'danger');
            }
        }

        // Go to parent directory
        function goToParentDirectory() {
            if (fileTreeData && fileTreeData.parent_directory) {
                currentDirectory = fileTreeData.parent_directory;
                loadFileTree();
            }
        }

        // Render file tree
        function renderFileTree() {
            if (!fileTreeData || !fileTreeData.tree) {
                fileTree.innerHTML = '<div class="alert alert-warning">No data to display</div>';
                return;
            }
            
            // Update is_excluded status based on current excludedPaths
            updateExclusionStatus(fileTreeData.tree);
            
            fileTree.innerHTML = '';
            renderTreeNode(fileTreeData.tree, fileTree, 0);
        }
        
        // Update exclusion status in tree data
        function updateExclusionStatus(node) {
            node.is_excluded = excludedPaths.includes(node.path);
            if (node.children) {
                node.children.forEach(child => updateExclusionStatus(child));
            }
        }

        // Render individual tree node
        function renderTreeNode(node, container, level) {
            const nodeDiv = document.createElement('div');
            
            const treeItem = document.createElement('div');
            treeItem.className = `tree-item ${node.is_excluded ? 'excluded' : ''}`;
            
            // Expand/collapse toggle
            const expandToggle = document.createElement('button');
            expandToggle.className = `expand-toggle ${!node.has_children ? 'invisible' : ''}`;
            expandToggle.innerHTML = expandedNodes.has(node.id) ? 
                '<i class="fas fa-chevron-down"></i>' : 
                '<i class="fas fa-chevron-right"></i>';
            
            expandToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNodeExpansion(node.id);
            });
            
            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'tree-checkbox';
            checkbox.checked = !node.is_excluded;
            checkbox.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleNodeExclusion(node.path);
            });
            
            // Icon
            const icon = document.createElement('i');
            icon.className = `tree-icon ${node.is_file ? 'fas fa-file' : 'fas fa-folder'}`;
            
            // Name
            const nameSpan = document.createElement('span');
            nameSpan.className = 'tree-name';
            nameSpan.textContent = node.name;
            nameSpan.addEventListener('click', () => {
                if (!node.is_file) {
                    navigateToDirectory(node.path);
                }
            });
            
            // Metadata
            const metaSpan = document.createElement('span');
            metaSpan.className = 'tree-meta';
            if (node.is_file && node.size !== null) {
                metaSpan.textContent = formatFileSize(node.size);
            } else if (!node.is_file && node.child_count !== undefined) {
                metaSpan.textContent = `${node.child_count} items`;
            }
            
            // Assemble tree item
            treeItem.appendChild(expandToggle);
            treeItem.appendChild(checkbox);
            treeItem.appendChild(icon);
            treeItem.appendChild(nameSpan);
            treeItem.appendChild(metaSpan);
            
            nodeDiv.appendChild(treeItem);
            
            // Children container
            if (node.children && node.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = `tree-children ${expandedNodes.has(node.id) ? '' : 'collapsed'}`;
                
                node.children.forEach(child => {
                    renderTreeNode(child, childrenDiv, level + 1);
                });
                
                nodeDiv.appendChild(childrenDiv);
            }
            
            container.appendChild(nodeDiv);
        }

        // Navigate to directory
        function navigateToDirectory(path) {
            currentDirectory = path;
            expandedNodes.clear(); // Reset expansion state
            loadFileTree();
        }

        // Toggle node expansion
        function toggleNodeExpansion(nodeId) {
            if (expandedNodes.has(nodeId)) {
                expandedNodes.delete(nodeId);
            } else {
                expandedNodes.add(nodeId);
            }
            renderFileTree();
        }

        // Set all nodes expanded/collapsed
        function setAllExpanded(expanded) {
            if (expanded) {
                // Expand all nodes
                function collectNodeIds(node) {
                    if (node.has_children) {
                        expandedNodes.add(node.id);
                    }
                    if (node.children) {
                        node.children.forEach(collectNodeIds);
                    }
                }
                collectNodeIds(fileTreeData.tree);
            } else {
                // Collapse all nodes
                expandedNodes.clear();
            }
            renderFileTree();
        }

        // Helper function to find a node by path in the tree
        function findNodeByPath(node, targetPath) {
            if (node.path === targetPath) {
                return node;
            }
            if (node.children) {
                for (const child of node.children) {
                    const found = findNodeByPath(child, targetPath);
                    if (found) return found;
                }
            }
            return null;
        }

        // Helper function to collect all descendant paths from a node
        function collectDescendantPaths(node) {
            const paths = [];
            if (node.children) {
                node.children.forEach(child => {
                    paths.push(child.path);
                    paths.push(...collectDescendantPaths(child));
                });
            }
            return paths;
        }

        // Toggle node exclusion
        function toggleNodeExclusion(path) {
            // Find the node in the tree
            const node = findNodeByPath(fileTreeData.tree, path);
            if (!node) return;

            const isCurrentlyExcluded = excludedPaths.includes(path);
            
            if (isCurrentlyExcluded) {
                // Remove this path from exclusions
                excludedPaths = excludedPaths.filter(p => p !== path);
                
                // If it's a folder, also remove all descendant paths
                if (!node.is_file) {
                    const descendantPaths = collectDescendantPaths(node);
                    excludedPaths = excludedPaths.filter(p => !descendantPaths.includes(p));
                }
            } else {
                // Add this path to exclusions
                excludedPaths.push(path);
                
                // If it's a folder, also add all descendant paths
                if (!node.is_file) {
                    const descendantPaths = collectDescendantPaths(node);
                    descendantPaths.forEach(p => {
                        if (!excludedPaths.includes(p)) {
                            excludedPaths.push(p);
                        }
                    });
                }
            }
            
            updateExclusionTags();
            renderFileTree(); // Re-render to show changes
        }

        // Set all selections
        function setAllSelections(exclude) {
            excludedPaths = [];
            if (exclude) {
                // Add all paths to exclusions
                function collectPaths(node) {
                    excludedPaths.push(node.path);
                    if (node.children) {
                        node.children.forEach(collectPaths);
                    }
                }
                collectPaths(fileTreeData.tree);
            }
            updateExclusionTags();
            renderFileTree();
        }

        // Update exclusion tags
        function updateExclusionTags() {
            exclusionTags.innerHTML = '';
            excludedPaths.forEach(path => {
                const tag = document.createElement('div');
                tag.className = 'exclusion-tag';
                
                const pathSpan = document.createElement('span');
                pathSpan.textContent = path.length > 50 ? '...' + path.slice(-47) : path;
                pathSpan.title = path;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '×';
                removeBtn.addEventListener('click', () => removeExclusion(path));
                
                tag.appendChild(pathSpan);
                tag.appendChild(removeBtn);
                exclusionTags.appendChild(tag);
            });
        }

        // Remove exclusion
        function removeExclusion(path) {
            const index = excludedPaths.indexOf(path);
            if (index > -1) {
                excludedPaths.splice(index, 1);
                updateExclusionTags();
                renderFileTree();
            }
        }

        // Clear all exclusions
        function clearExclusions() {
            excludedPaths = [];
            updateExclusionTags();
            renderFileTree();
        }

        // Run analysis
        async function runAnalysis() {
            try {
                setStatus('Starting analysis...', 'warning');
                analyzeBtn.disabled = true;
                
                // Start progress polling
                const progressInterval = setInterval(updateProgress, 500);
                
                // Collect all checked (included) paths
                includedPaths = [];
                collectIncludedPaths(fileTreeData.tree);
                
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        directory: currentDirectory,
                        excluded_paths: excludedPaths,
                        included_paths: includedPaths
                    })
                });
                
                const result = await response.json();
                
                // Stop progress polling
                clearInterval(progressInterval);
                
                if (result.success) {
                    analysisResult = result.analysis_data;
                    displayAnalysisResult(result);
                    setStatus('Analysis Complete', 'success');
                    exportBtn.disabled = false;
                    hideProgressBar();
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                analysisResultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                setStatus('Error', 'danger');
                hideProgressBar();
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        // Update progress during analysis
        async function updateProgress() {
            try {
                const response = await fetch('/api/progress');
                const progress = await response.json();
                
                if (progress.status === 'analyzing') {
                    const progressPercent = progress.progress || 0;
                    const currentFile = progress.current_file || '';
                    const currentLanguage = progress.current_language || '';
                    const filesProcessed = progress.files_processed || 0;
                    const totalFiles = progress.total_files || 0;
                    
                    // Update status with detailed progress
                    let statusMessage = progress.message || 'Analyzing...';
                    
                    // Handle dependency analysis progress
                    if (currentLanguage === 'dependency' && progress.dependency_progress) {
                        const depProgress = progress.dependency_progress;
                        statusMessage = depProgress.message || 'Analyzing dependencies...';
                        if (depProgress.total > 0) {
                            statusMessage += ` (${depProgress.current}/${depProgress.total})`;
                        }
                    } else if (currentFile) {
                        const fileName = currentFile.split('/').pop();
                        statusMessage = `${currentLanguage}: ${fileName} (${filesProcessed}/${totalFiles})`;
                    }
                    
                    setStatus(statusMessage, 'warning');
                    
                    // Update progress bar if it exists
                    updateProgressBar(progressPercent, filesProcessed, totalFiles);
                }
            } catch (error) {
                console.error('Failed to fetch progress:', error);
            }
        }

        // Update progress bar
        function updateProgressBar(percent, processed, total) {
            let progressBar = document.getElementById('analysis-progress');
            if (!progressBar) {
                // Create progress bar if it doesn't exist
                const statusDiv = document.getElementById('status');
                if (statusDiv && statusDiv.parentNode) {
                    progressBar = document.createElement('div');
                    progressBar.id = 'analysis-progress';
                    progressBar.className = 'progress mt-2';
                    progressBar.innerHTML = `
                        <div class="progress-bar" role="progressbar" style="width: 0%">
                            <span class="progress-text">0/0</span>
                        </div>
                    `;
                    statusDiv.parentNode.insertBefore(progressBar, statusDiv.nextSibling);
                }
            }
            
            if (progressBar) {
                const progressBarInner = progressBar.querySelector('.progress-bar');
                const progressText = progressBar.querySelector('.progress-text');
                
                if (progressBarInner) {
                    progressBarInner.style.width = `${percent}%`;
                    progressBarInner.setAttribute('aria-valuenow', percent);
                }
                
                if (progressText) {
                    progressText.textContent = `${processed}/${total}`;
                }
                
                // Show progress bar
                progressBar.style.display = 'block';
            }
        }

        // Hide progress bar
        function hideProgressBar() {
            const progressBar = document.getElementById('analysis-progress');
            if (progressBar) {
                progressBar.style.display = 'none';
            }
        }

        // Display analysis result
        function displayAnalysisResult(result) {
            if (!result.analysis_data) {
                analysisResultDiv.innerHTML = `<div class="alert alert-info">${result.message}</div>`;
                return;
            }
            
            const data = result.analysis_data;
            
            // Add view detailed results button
            const viewResultsButton = `
                <div class="text-center mb-4">
                    <a href="/analysis-results" class="btn btn-primary">
                        <i class="fas fa-chart-line"></i> View Detailed Results
                    </a>
                </div>
            `;
            
            // Build summary cards with icons
            const summaryCards = `
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body position-relative">
                                <i class="fas fa-file-code summary-icon"></i>
                                <h5 class="card-title">${data.total_files || 0}</h5>
                                <p class="card-text">Files Analyzed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body position-relative">
                                <i class="fas fa-exclamation-circle summary-icon"></i>
                                <h5 class="card-title">${data.findings ? data.findings.length : 0}</h5>
                                <p class="card-text">Findings</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body position-relative">
                                <i class="fas fa-cube summary-icon"></i>
                                <h5 class="card-title">${data.dependencies ? data.dependencies.length : 0}</h5>
                                <p class="card-text">Dependencies</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center h-100">
                            <div class="card-body position-relative">
                                <i class="fas fa-shield-alt summary-icon"></i>
                                <h5 class="card-title">${data.vulnerabilities ? data.vulnerabilities.length : 0}</h5>
                                <p class="card-text">Vulnerabilities</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Build findings section with cards and filtering
            let findingsSection = '';
            if (data.findings && data.findings.length > 0) {
                // Create filter controls
                const findingsFilters = `
                    <div class="findings-filters mb-3">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="severity-filter">Severity</label>
                                    <select class="form-select form-select-sm" id="severity-filter">
                                        <option value="all">All Severities</option>
                                        <option value="critical">Critical</option>
                                        <option value="error">Error</option>
                                        <option value="warning">Warning</option>
                                        <option value="info">Info</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="pattern-type-filter">Pattern Type</label>
                                    <select class="form-select form-select-sm" id="pattern-type-filter">
                                        <option value="all">All Types</option>
                                        <option value="code_smell">Code Smell</option>
                                        <option value="anti_pattern">Anti-Pattern</option>
                                        <option value="design_pattern">Design Pattern</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="file-filter">File Path</label>
                                    <input type="text" class="form-control form-control-sm" id="file-filter" placeholder="Filter by file path">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="findings-per-page">Per Page</label>
                                    <select class="form-select form-select-sm" id="findings-per-page">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Create pagination controls
                const paginationControls = `
                    <div class="findings-pagination d-flex justify-content-between align-items-center mb-3">
                        <div class="pagination-info">
                            <span id="findings-showing">Showing 1-10 of ${data.findings.length} findings</span>
                        </div>
                        <div class="pagination-controls">
                            <button class="btn btn-sm btn-outline-secondary" id="findings-prev-page" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span class="mx-2" id="findings-page-info">Page 1</span>
                            <button class="btn btn-sm btn-outline-secondary" id="findings-next-page">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Create findings cards container (will be populated by JavaScript)
                const findingsCardsContainer = `
                    <div id="findings-cards-container" class="findings-list">
                        <!-- Findings cards will be dynamically inserted here -->
                    </div>
                `;
                
                findingsSection = `
                    <div class="mb-5">
                        <div class="section-header">
                            <h6><i class="fas fa-exclamation-triangle text-warning"></i> Code Analysis Findings</h6>
                            <small class="text-muted">${data.findings.length} findings total</small>
                        </div>
                        ${findingsFilters}
                        ${paginationControls}
                        ${findingsCardsContainer}
                    </div>
                `;
                
                // Store findings data for client-side filtering and pagination
                window.findingsData = data.findings;
                
                // Initialize findings display after rendering
                setTimeout(() => {
                    initializeFindingsDisplay();
                }, 0);
            } else {
                findingsSection = `
                    <div class="mb-5">
                        <div class="section-header">
                            <h6><i class="fas fa-exclamation-triangle text-warning"></i> Code Analysis Findings</h6>
                        </div>
                        <div class="empty-state">
                            <i class="fas fa-check-circle text-success"></i>
                            <p>No issues found! Your code looks great.</p>
                        </div>
                    </div>
                `;
            }
            
            // Build dependencies section with filtering
            let dependenciesSection = '';
            if (data.dependencies && data.dependencies.length > 0) {
                // Create filter controls for dependencies
                const depFilters = `
                    <div class="dependencies-filters mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="dep-name-filter">Name</label>
                                    <input type="text" class="form-control form-control-sm" id="dep-name-filter" placeholder="Filter by name">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="dep-license-filter">License</label>
                                    <select class="form-select form-select-sm" id="dep-license-filter">
                                        <option value="all">All Licenses</option>
                                        <!-- Will be populated dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="dep-sort">Sort By</label>
                                    <select class="form-select form-select-sm" id="dep-sort">
                                        <option value="name">Name</option>
                                        <option value="version">Version</option>
                                        <option value="license">License</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="deps-per-page">Per Page</label>
                                    <select class="form-select form-select-sm" id="deps-per-page">
                                        <option value="12">12</option>
                                        <option value="24">24</option>
                                        <option value="48">48</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Create pagination controls for dependencies
                const depPaginationControls = `
                    <div class="deps-pagination d-flex justify-content-between align-items-center mb-3">
                        <div class="pagination-info">
                            <span id="deps-showing">Showing 1-12 of ${data.dependencies.length} dependencies</span>
                        </div>
                        <div class="pagination-controls">
                            <button class="btn btn-sm btn-outline-secondary" id="deps-prev-page" disabled>
                                <i class="fas fa-chevron-left"></i> Previous
                            </button>
                            <span class="mx-2" id="deps-page-info">Page 1</span>
                            <button class="btn btn-sm btn-outline-secondary" id="deps-next-page">
                                Next <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                // Create dependencies container (will be populated by JavaScript)
                const depsContainer = `
                    <div id="dependencies-container">
                        <div class="row" id="dependencies-cards-container">
                            <!-- Dependency cards will be dynamically inserted here -->
                        </div>
                    </div>
                `;
                
                dependenciesSection = `
                    <div class="mb-5">
                        <div class="section-header">
                            <h6><i class="fas fa-cube text-primary"></i> Project Dependencies</h6>
                            <small class="text-muted">${data.dependencies.length} dependencies total</small>
                        </div>
                        ${depFilters}
                        ${depPaginationControls}
                        ${depsContainer}
                    </div>
                `;
                
                // Store dependencies data for client-side filtering and pagination
                window.dependenciesData = data.dependencies;
                
                // Initialize dependencies display after rendering
                setTimeout(() => {
                    initializeDependenciesDisplay();
                }, 0);
            } else {
                dependenciesSection = `
                    <div class="mb-5">
                        <div class="section-header">
                            <h6><i class="fas fa-cube text-primary"></i> Project Dependencies</h6>
                        </div>
                        <div class="empty-state">
                            <i class="fas fa-cube"></i>
                            <p>No dependencies found in this project.</p>
                        </div>
                    </div>
                `;
            }
            
            // Build vulnerabilities section
            let vulnerabilitiesSection = '';
            if (data.vulnerabilities && data.vulnerabilities.length > 0) {
                const vulnCards = data.vulnerabilities.map(vuln => `
                    <div class="alert vulnerability-card alert-${getSeverityColor(vuln.severity)} mb-3">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-shield-alt me-3 mt-1"></i>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading mb-1">${vuln.title || vuln.advisory_id || 'Security Vulnerability'}</h6>
                                <span class="badge bg-${getSeverityColor(vuln.severity)} mb-2">${vuln.severity || 'Unknown'} Severity</span>
                                <p class="mb-0">${escapeHtml(vuln.description || 'No description available')}</p>
                                ${vuln.source ? `<small class="text-muted mt-2 d-block">Source: ${vuln.source}</small>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                vulnerabilitiesSection = `
                    <div class="mb-5">
                        <div class="section-header">
                            <h6><i class="fas fa-shield-alt text-danger"></i> Security Vulnerabilities</h6>
                        </div>
                        ${vulnCards}
                    </div>
                `;
            }
            
            analysisResultDiv.innerHTML = `
                <div class="analysis-results">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-check-circle text-success"></i> Analysis Complete</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleRawData()">
                            <i class="fas fa-code"></i> View Raw Data
                        </button>
                    </div>
                    
                    <div class="mb-3">
                        <p class="mb-1"><strong>Directory:</strong> ${currentDirectory}</p>
                        <p class="mb-0"><strong>Excluded Paths:</strong> ${excludedPaths.length > 0 ? excludedPaths.length + ' items' : 'None'}</p>
                    </div>
                    
                    ${viewResultsButton}
                    ${summaryCards}
                    ${findingsSection}
                    ${dependenciesSection}
                    ${vulnerabilitiesSection}
                    
                    <div id="raw-data" class="mt-5" style="display: none;">
                        <div class="section-header">
                            <h6><i class="fas fa-code"></i> Raw Analysis Data</h6>
                        </div>
                        <pre class="p-3"><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </div>
                </div>
            `;
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // Helper function to get severity color
        function getSeverityColor(severity) {
            const severityMap = {
                'critical': 'danger',
                'high': 'danger',
                'medium': 'warning',
                'low': 'info',
                'info': 'secondary'
            };
            return severityMap[severity?.toLowerCase()] || 'secondary';
        }
        
        // Toggle raw data view
        window.toggleRawData = function() {
            const rawDataDiv = document.getElementById('raw-data');
            rawDataDiv.style.display = rawDataDiv.style.display === 'none' ? 'block' : 'none';
        }
        
        // Initialize findings display with filtering and pagination
        function initializeFindingsDisplay() {
            if (!window.findingsData) return;
            
            const findings = window.findingsData;
            const container = document.getElementById('findings-cards-container');
            const severityFilter = document.getElementById('severity-filter');
            const patternTypeFilter = document.getElementById('pattern-type-filter');
            const fileFilter = document.getElementById('file-filter');
            const perPageSelect = document.getElementById('findings-per-page');
            const prevPageBtn = document.getElementById('findings-prev-page');
            const nextPageBtn = document.getElementById('findings-next-page');
            const pageInfo = document.getElementById('findings-page-info');
            const showingInfo = document.getElementById('findings-showing');
            
            let currentPage = 1;
            let itemsPerPage = parseInt(perPageSelect.value);
            
            // Populate unique pattern types in the filter
            const patternTypes = [...new Set(findings.map(f => f.type || f.pattern_type || 'Unknown'))];
            patternTypes.forEach(type => {
                if (!['code_smell', 'anti_pattern', 'design_pattern'].includes(type.toLowerCase())) {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    patternTypeFilter.appendChild(option);
                }
            });
            
            // Function to filter findings
            function filterFindings() {
                const severity = severityFilter.value;
                const patternType = patternTypeFilter.value;
                const filePath = fileFilter.value.toLowerCase();
                
                return findings.filter(finding => {
                    // Filter by severity
                    if (severity !== 'all' && finding.severity !== severity) {
                        return false;
                    }
                    
                    // Filter by pattern type
                    const findingType = (finding.type || finding.pattern_type || '').toLowerCase();
                    if (patternType !== 'all' && findingType !== patternType.toLowerCase()) {
                        return false;
                    }
                    
                    // Filter by file path
                    if (filePath && !(finding.file_path || '').toLowerCase().includes(filePath)) {
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // Function to render findings
            function renderFindings() {
                const filteredFindings = filterFindings();
                const totalItems = filteredFindings.length;
                const totalPages = itemsPerPage === 'all' ? 1 : Math.ceil(totalItems / itemsPerPage);
                
                // Adjust current page if needed
                if (currentPage > totalPages) {
                    currentPage = totalPages || 1;
                }
                
                // Calculate start and end indices
                const startIndex = itemsPerPage === 'all' ? 0 : (currentPage - 1) * itemsPerPage;
                const endIndex = itemsPerPage === 'all' ? totalItems : Math.min(startIndex + itemsPerPage, totalItems);
                
                // Update pagination info
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                showingInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalItems} findings`;
                
                // Update pagination buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
                
                // Clear container
                container.innerHTML = '';
                
                // Render findings
                const displayedFindings = filteredFindings.slice(startIndex, endIndex);
                
                if (displayedFindings.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-filter text-muted"></i>
                            <p>No findings match your filters.</p>
                        </div>
                    `;
                    return;
                }
                
                displayedFindings.forEach(finding => {
                    const fileName = finding.file_path ? finding.file_path.split('/').pop() : 'Unknown';
                    const severityClass = `severity-${finding.severity || 'low'}`;
                    
                    const card = document.createElement('div');
                    card.className = `card findings-card ${severityClass} mb-3`;
                    card.innerHTML = `
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <span class="badge bg-${getSeverityColor(finding.severity)}">${finding.severity || 'info'}</span>
                                    <span class="badge bg-secondary ms-1">${finding.type || finding.pattern_type || 'Unknown'}</span>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-file-code"></i> ${fileName}
                                    ${finding.line_number ? ` : ${finding.line_number}` : ''}
                                </small>
                            </div>
                            <p class="mb-0">${escapeHtml(finding.message || finding.description || '')}</p>
                            ${finding.suggestion ? `<small class="text-muted mt-1 d-block"><i class="fas fa-lightbulb"></i> ${escapeHtml(finding.suggestion)}</small>` : ''}
                        </div>
                    `;
                    container.appendChild(card);
                });
            }
            
            // Event listeners
            severityFilter.addEventListener('change', () => {
                currentPage = 1;
                renderFindings();
            });
            
            patternTypeFilter.addEventListener('change', () => {
                currentPage = 1;
                renderFindings();
            });
            
            fileFilter.addEventListener('input', () => {
                currentPage = 1;
                renderFindings();
            });
            
            perPageSelect.addEventListener('change', () => {
                itemsPerPage = perPageSelect.value === 'all' ? 'all' : parseInt(perPageSelect.value);
                currentPage = 1;
                renderFindings();
            });
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderFindings();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                const filteredFindings = filterFindings();
                const totalPages = itemsPerPage === 'all' ? 1 : Math.ceil(filteredFindings.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    renderFindings();
                }
            });
            
            // Initial render
            renderFindings();
        }
        
        // Initialize dependencies display with filtering and pagination
        function initializeDependenciesDisplay() {
            if (!window.dependenciesData) return;
            
            const dependencies = window.dependenciesData;
            const container = document.getElementById('dependencies-cards-container');
            const nameFilter = document.getElementById('dep-name-filter');
            const licenseFilter = document.getElementById('dep-license-filter');
            const sortSelect = document.getElementById('dep-sort');
            const perPageSelect = document.getElementById('deps-per-page');
            const prevPageBtn = document.getElementById('deps-prev-page');
            const nextPageBtn = document.getElementById('deps-next-page');
            const pageInfo = document.getElementById('deps-page-info');
            const showingInfo = document.getElementById('deps-showing');
            
            let currentPage = 1;
            let itemsPerPage = parseInt(perPageSelect.value);
            
            // Populate unique licenses in the filter
            const licenses = [...new Set(dependencies.map(d => d.license || 'Unknown'))];
            licenses.sort().forEach(license => {
                const option = document.createElement('option');
                option.value = license;
                option.textContent = license;
                licenseFilter.appendChild(option);
            });
            
            // Function to filter dependencies
            function filterDependencies() {
                const name = nameFilter.value.toLowerCase();
                const license = licenseFilter.value;
                
                return dependencies.filter(dep => {
                    // Filter by name
                    if (name && !(dep.name || '').toLowerCase().includes(name)) {
                        return false;
                    }
                    
                    // Filter by license
                    if (license !== 'all' && dep.license !== license) {
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // Function to sort dependencies
            function sortDependencies(deps) {
                const sortBy = sortSelect.value;
                
                return [...deps].sort((a, b) => {
                    const aValue = a[sortBy] || '';
                    const bValue = b[sortBy] || '';
                    
                    return aValue.localeCompare(bValue);
                });
            }
            
            // Function to render dependencies
            function renderDependencies() {
                let filteredDeps = filterDependencies();
                filteredDeps = sortDependencies(filteredDeps);
                
                const totalItems = filteredDeps.length;
                const totalPages = itemsPerPage === 'all' ? 1 : Math.ceil(totalItems / itemsPerPage);
                
                // Adjust current page if needed
                if (currentPage > totalPages) {
                    currentPage = totalPages || 1;
                }
                
                // Calculate start and end indices
                const startIndex = itemsPerPage === 'all' ? 0 : (currentPage - 1) * itemsPerPage;
                const endIndex = itemsPerPage === 'all' ? totalItems : Math.min(startIndex + itemsPerPage, totalItems);
                
                // Update pagination info
                pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                showingInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalItems} dependencies`;
                
                // Update pagination buttons
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages || totalPages === 0;
                
                // Clear container
                container.innerHTML = '';
                
                // Render dependencies
                const displayedDeps = filteredDeps.slice(startIndex, endIndex);
                
                if (displayedDeps.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="empty-state">
                                <i class="fas fa-filter text-muted"></i>
                                <p>No dependencies match your filters.</p>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                displayedDeps.forEach(dep => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 mb-3';
                    col.innerHTML = `
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title mb-1">${dep.name || 'Unknown'}</h6>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="badge bg-primary">${dep.version || 'N/A'}</span>
                                    <span class="badge bg-secondary">${dep.license || 'Unknown'}</span>
                                </div>
                                <small class="text-muted">${escapeHtml(dep.description || 'No description available')}</small>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                });
            }
            
            // Event listeners
            nameFilter.addEventListener('input', () => {
                currentPage = 1;
                renderDependencies();
            });
            
            licenseFilter.addEventListener('change', () => {
                currentPage = 1;
                renderDependencies();
            });
            
            sortSelect.addEventListener('change', () => {
                renderDependencies();
            });
            
            perPageSelect.addEventListener('change', () => {
                itemsPerPage = perPageSelect.value === 'all' ? 'all' : parseInt(perPageSelect.value);
                currentPage = 1;
                renderDependencies();
            });
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderDependencies();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                const filteredDeps = filterDependencies();
                const totalPages = itemsPerPage === 'all' ? 1 : Math.ceil(filteredDeps.length / itemsPerPage);
                
                if (currentPage < totalPages) {
                    currentPage++;
                    renderDependencies();
                }
            });
            
            // Initial render
            renderDependencies();
        }
        
        // Show analysis history
        async function showAnalysisHistory() {
            try {
                const response = await fetch('/api/analysis-history');
                const data = await response.json();
                
                if (data.history.length === 0) {
                    analysisResultDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> No analysis history available yet.
                        </div>
                    `;
                    return;
                }
                
                // Build history table
                const historyRows = data.history.map(entry => {
                    const timestamp = new Date(entry.timestamp).toLocaleString();
                    const directory = entry.directory || 'Unknown';
                    const filesCount = entry.result.total_files || 0;
                    const findingsCount = entry.result.findings ? entry.result.findings.length : 0;
                    
                    return `
                        <tr id="history-row-${entry.id}">
                            <td>${entry.id}</td>
                            <td>${timestamp}</td>
                            <td title="${directory}">${directory.length > 30 ? '...' + directory.slice(-27) : directory}</td>
                            <td>${filesCount}</td>
                            <td>${findingsCount}</td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadHistoricalAnalysis(${entry.id})" title="View this analysis">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/analysis-results?id=${entry.id}" class="btn btn-sm btn-outline-info" title="View detailed results">
                                        <i class="fas fa-chart-line"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAnalysis(${entry.id})" title="Delete this analysis">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).reverse().join(''); // Show newest first
                
                analysisResultDiv.innerHTML = `
                    <div class="analysis-history">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6><i class="fas fa-history"></i> Analysis History</h6>
                            <div>
                                <button class="btn btn-sm btn-outline-danger me-2" onclick="clearAllHistory()" ${data.history.length === 0 ? 'disabled' : ''}>
                                    <i class="fas fa-trash-alt"></i> Clear All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="window.location.reload()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Timestamp</th>
                                        <th>Directory</th>
                                        <th>Files</th>
                                        <th>Findings</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${historyRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } catch (error) {
                analysisResultDiv.innerHTML = `<div class="alert alert-danger">Error loading history: ${error.message}</div>`;
            }
        }
        
        // Load historical analysis
        window.loadHistoricalAnalysis = async function(analysisId) {
            try {
                const response = await fetch(`/api/analysis-history/${analysisId}`);
                const data = await response.json();
                
                // Display the historical result
                displayAnalysisResult({
                    success: true,
                    analysis_data: data.result,
                    message: `Historical analysis from ${new Date(data.timestamp).toLocaleString()}`
                });
                
                // Update current directory if different
                if (data.directory !== currentDirectory) {
                    currentDirectory = data.directory;
                    directoryInput.value = currentDirectory;
                    currentPathDiv.textContent = currentDirectory;
                }
                
                // Update excluded paths
                excludedPaths = data.excluded_paths || [];
                updateExclusionTags();
                
            } catch (error) {
                alert(`Error loading analysis: ${error.message}`);
            }
        }
        
        // Delete analysis
        window.deleteAnalysis = async function(analysisId) {
            if (!confirm('Are you sure you want to delete this analysis?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/analysis-history/${analysisId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    // Remove the row from the table
                    const row = document.getElementById(`history-row-${analysisId}`);
                    if (row) {
                        row.style.transition = 'opacity 0.3s';
                        row.style.opacity = '0';
                        setTimeout(() => row.remove(), 300);
                    }
                    
                    // Check if table is empty
                    setTimeout(() => {
                        const tbody = document.querySelector('.analysis-history tbody');
                        if (tbody && tbody.children.length === 0) {
                            showAnalysisHistory(); // Refresh to show empty state
                        }
                    }, 350);
                } else {
                    alert('Failed to delete analysis');
                }
            } catch (error) {
                alert(`Error deleting analysis: ${error.message}`);
            }
        }
        
        // Clear all history
        window.clearAllHistory = async function() {
            if (!confirm('Are you sure you want to clear all analysis history? This cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/analysis-history', {
                    method: 'DELETE'
                });
                const result = await response.json();
                
                if (result.success) {
                    showAnalysisHistory(); // Refresh to show empty state
                } else {
                    alert('Failed to clear history');
                }
            } catch (error) {
                alert(`Error clearing history: ${error.message}`);
            }
        }

        // Export analysis
        async function exportAnalysis(format) {
            try {
                setStatus('Exporting...', 'warning');
                
                const formData = new FormData();
                formData.append('format', format);
                
                const response = await fetch('/api/export-analysis', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Analysis exported to: ${result.file_path}`);
                    setStatus('Export Complete', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                alert(`Export failed: ${error.message}`);
                setStatus('Error', 'danger');
            }
        }

        // Set status
        function setStatus(text, type) {
            statusBadge.textContent = text;
            statusBadge.className = `status-badge bg-${type}`;
        }

        // Collect included paths from tree
        function collectIncludedPaths(node) {
            // If this node is not excluded, include it
            if (!excludedPaths.includes(node.path)) {
                includedPaths.push(node.path);
            }
            
            // Process children recursively
            if (node.children) {
                node.children.forEach(child => collectIncludedPaths(child));
            }
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Directory picker functions
        function getCurrentUserHome() {
            // Try to detect user home directory
            if (typeof navigator !== 'undefined' && navigator.userAgent) {
                if (navigator.userAgent.includes('Mac')) {
                    return '/Users/' + (window.location.hostname || 'user');
                } else if (navigator.userAgent.includes('Windows')) {
                    return 'C:\\Users\\' + (window.location.hostname || 'user');
                } else {
                    return '/home/' + (window.location.hostname || 'user');
                }
            }
            return '/';
        }

        // Load directory picker
        async function loadDirectoryPicker() {
            try {
                directoryList.innerHTML = '<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i> Loading directories...</div>';
                
                const response = await fetch(`/api/browse-directories?path=${encodeURIComponent(pickerCurrentDirectory)}`);
                const data = await response.json();
                
                if (response.ok) {
                    pickerData = data;
                    currentPickerPathDiv.textContent = data.current_directory;
                    
                    // Update parent button
                    pickerParentBtn.disabled = !data.parent_directory;
                    
                    renderDirectoryPicker();
                } else {
                    throw new Error(data.detail || 'Failed to load directories');
                }
            } catch (error) {
                directoryList.innerHTML = `<div class="alert alert-danger m-3">Error: ${error.message}</div>`;
            }
        }

        // Render directory picker
        function renderDirectoryPicker() {
            if (!pickerData) return;
            
            // Render common directories
            if (pickerData.common_directories && pickerData.common_directories.length > 0) {
                commonDirectoriesDiv.style.display = 'block';
                commonDirsList.innerHTML = '';
                
                pickerData.common_directories.forEach(dir => {
                    const btn = document.createElement('button');
                    btn.className = 'common-dir-btn';
                    btn.innerHTML = `<i class="fas fa-folder"></i> ${dir.name}`;
                    btn.addEventListener('click', () => navigateToPickerDirectory(dir.path));
                    commonDirsList.appendChild(btn);
                });
            } else {
                commonDirectoriesDiv.style.display = 'none';
            }
            
            // Render directory list
            directoryList.innerHTML = '';
            
            if (pickerData.directories.length === 0) {
                directoryList.innerHTML = '<div class="empty-state p-3"><i class="fas fa-folder-open"></i><p>No accessible directories found</p></div>';
                return;
            }
            
            pickerData.directories.forEach(dir => {
                const dirItem = document.createElement('div');
                dirItem.className = 'directory-item';
                dirItem.innerHTML = `
                    <i class="fas fa-folder"></i>
                    <span>${dir.name}</span>
                `;
                
                dirItem.addEventListener('click', () => selectPickerDirectory(dir.path));
                dirItem.addEventListener('dblclick', () => navigateToPickerDirectory(dir.path));
                
                directoryList.appendChild(dirItem);
            });
        }

        // Navigate to directory in picker
        function navigateToPickerDirectory(path) {
            pickerCurrentDirectory = path;
            pickerSelectedDirectory = null;
            updatePickerSelection();
            loadDirectoryPicker();
        }

        // Select directory in picker
        function selectPickerDirectory(path) {
            pickerSelectedDirectory = path;
            updatePickerSelection();
        }

        // Update picker selection display
        function updatePickerSelection() {
            // Clear previous selections
            document.querySelectorAll('.directory-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            if (pickerSelectedDirectory) {
                // Highlight selected directory
                const selectedItem = Array.from(document.querySelectorAll('.directory-item')).find(item => {
                    const span = item.querySelector('span');
                    return span && pickerSelectedDirectory.endsWith('/' + span.textContent);
                });
                
                if (selectedItem) {
                    selectedItem.classList.add('selected');
                }
                
                selectedDirectoryDisplay.textContent = pickerSelectedDirectory;
                selectDirectoryBtn.disabled = false;
            } else {
                selectedDirectoryDisplay.textContent = 'None';
                selectDirectoryBtn.disabled = true;
            }
        }
    </script>
</body>
</html>
